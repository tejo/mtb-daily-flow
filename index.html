<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e1e1e">
  <meta name="description" content="10-minute daily MTB mobility and reactivity training routine.">
  <title>MTB Pro-Training 10'</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icon-192.svg">
  <link rel="apple-touch-icon" href="icon-192.svg">
  <style>
    :root {
      --bg: #121212;
      --card: #1e1e1e;
      --primary: #f39c12;
      --secondary: #e74c3c;
      --success: #27ae60;
      --text: #e0e0e0;
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 15px;
    }

    #app-container {
      max-width: 450px;
      width: 100%;
      background: var(--card);
      padding: 25px;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      text-align: center;
      border: 1px solid #333;
    }

    h1 {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #timer {
      font-size: 5.5rem;
      font-weight: 800;
      line-height: 1;
      margin: 10px 0;
      color: #fff;
      font-variant-numeric: tabular-nums;
    }

    #exercise-name {
      font-size: 1.2rem;
      font-weight: 600;
      height: auto;
      min-height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
      color: var(--primary);
    }

    #exercise-desc {
      font-size: 0.9rem;
      color: #aaa;
      margin-bottom: 15px;
      line-height: 1.4;
      min-height: 3rem;
    }

    #video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      margin-bottom: 20px;
      border: 2px solid #333;
    }

    #video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    button {
      border: none;
      padding: 15px;
      font-size: 1rem;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }

    #startBtn {
      background: var(--success);
      color: white;
      grid-column: span 2;
    }

    #pauseBtn {
      background: #555;
      color: white;
      display: none;
    }

    #resetBtn {
      background: var(--secondary);
      color: white;
      display: none;
    }

    #prevBtn, #nextBtn {
      background: #333;
      color: var(--text);
      display: none;
    }

    .progress-box {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 10px;
      margin: 20px 0;
      overflow: hidden;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background: var(--primary);
      transition: width 1s linear;
    }

    #exercise-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .indicator {
      width: 30px;
      height: 30px;
      background: #333;
      color: #888;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #444;
    }

    .indicator.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      transform: scale(1.1);
    }

    .indicator:hover {
      background: #444;
    }
  </style>
</head>

<body>

  <div id="app-container">
    <h1>MTB Daily Flow</h1>
    <div id="exercise-name">Ready for the session?</div>
    <div id="exercise-desc">Press START to begin your 10-minute routine.</div>
    <div id="timer">10:00</div>

    <div id="video-container">
      <div id="placeholder" style="padding-top: 20%; color: #666;">The video will appear here</div>
    </div>

    <div id="exercise-indicators"></div>

    <div class="progress-box">
      <div id="progress-bar"></div>
    </div>

    <div class="controls">
      <button id="prevBtn" onclick="prevExercise()">&laquo; PREV</button>
      <button id="nextBtn" onclick="nextExercise()">NEXT &raquo;</button>
      <button id="startBtn" onclick="toggleStart()">START WORKOUT</button>
      <button id="pauseBtn" onclick="togglePause()">PAUSE</button>
      <button id="resetBtn" onclick="resetWorkout()">RESET</button>
    </div>
  </div>

  <script>
    const rawExercises = [
      {
        name: "1. 90/90 Hip Switches",
        duration: 60,
        vid: "y_6i7nGHAio",
        desc: "Rotate knees from side to side. Keep torso upright without using hands for support."
      },
      {
        name: "2. World's Greatest Stretch",
        duration: 60,
        vid: "OCXMbIzYJTQ",
        desc: "From deep lunge, bring inside elbow to floor, then rotate arm to ceiling. Alternate sides.",
        doubleSide: true
      },
      {
        name: "3. Deep Squat with Reach",
        duration: 60,
        vid: "lQtui4VLBVA",
        desc: "Sink into a deep squat, heels down. Reach one arm to the sky while the other stays on the floor. Alternate sides."
      },
      {
        name: "4. Single Leg Balance (Clock)",
        duration: 90,
        vid: "mjzu4CEkTLE",
        desc: "Stand on one leg, knee slightly bent. Tap 12, 3, 6, 9 with floating foot.",
        doubleSide: true
      },
      {
        name: "5. Single Leg Deadlift ISO",
        duration: 90,
        vid: "SI1FEJK8i94",
        desc: "Hold 'T' position on one leg, hinging at hip with flat back. Keep hips level.",
        doubleSide: true
      },
      {
        name: "6. Pogo Hops (Reactivity)",
        duration: 60,
        vid: "j0nl5dWuqN4",
        desc: "Bounce on balls of feet using ankles. Minimal ground contact. 20s work / 10s rest x3."
      },
      {
        name: "7. Drop Squats (Attack Position)",
        duration: 60,
        vid: "Sm1HPlYdAT0",
        desc: "From tiptoes, reach up then quickly drop into Attack Position and stick the landing."
      },
      {
        name: "8. Plank Shoulder Taps",
        duration: 60,
        vid: "8rgurWd-PB8",
        desc: "High plank position, tap opposite shoulder. Keep hips perfectly stillâ€”no rocking."
      }
    ];

    const exercises = rawExercises;
    const SETUP_TIME = 5;
    const SWITCH_TIME = 5;

    let currentIdx = 0;
    let currentStep = 0; // 0: SETUP, 1: WORK/LEFT, 2: SWITCH, 3: RIGHT
    let timeLeft = 0;
    let totalElapsed = 0;
    let timerVar = null;
    let isPaused = false;
    let isRunning = false;
    let wakeLock = null;

    // Audio context for beeps
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Wake Lock functions
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('Wake Lock was released');
          });
          console.log('Wake Lock is active');
        } catch (err) {
          console.error(`${err.name}, ${err.message}`);
        }
      }
    }

    async function releaseWakeLock() {
      if (wakeLock !== null) {
        await wakeLock.release();
        wakeLock = null;
      }
    }

    // Re-acquire lock when page becomes visible again
    document.addEventListener('visibilitychange', async () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
      }
    });

    function playBeep(freq = 880, duration = 200) {
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.type = 'sine';
      oscillator.frequency.value = freq;
      gainNode.gain.value = 0.1;

      oscillator.start();
      setTimeout(() => {
        oscillator.stop();
      }, duration);
    }

    // Initialize indicators and preload thumbnails
    const indicatorsContainer = document.getElementById('exercise-indicators');
    exercises.forEach((ex, idx) => {
      // Create indicator
      const dot = document.createElement('div');
      dot.className = 'indicator';
      dot.innerText = idx + 1;
      dot.onclick = () => jumpToExercise(idx);
      indicatorsContainer.appendChild(dot);

      // Preload thumbnail to trigger SW caching
      const img = new Image();
      img.src = `https://i.ytimg.com/vi/${ex.vid}/hqdefault.jpg`;
    });

    // Handle network status changes
    window.addEventListener('online', () => {
       if(currentIdx < exercises.length) loadExercise(currentIdx);
    });
    window.addEventListener('offline', () => {
       if(currentIdx < exercises.length) loadExercise(currentIdx);
    });

    function jumpToExercise(idx) {
      // Calculate elapsed time for previous exercises
      let newTotalElapsed = 0;
      for (let i = 0; i < idx; i++) {
        newTotalElapsed += exercises[i].duration;
      }
      totalElapsed = newTotalElapsed;

      if (isRunning) {
        loadExercise(idx);
        updateUI();
      } else {
        // If not running, just start from this exercise
        toggleStart();
        loadExercise(idx);
        updateUI();
      }
    }

    function updateIndicators(idx) {
      const dots = document.getElementsByClassName('indicator');
      for (let i = 0; i < dots.length; i++) {
        dots[i].classList.remove('active');
        if (i === idx) dots[i].classList.add('active');
      }
    }

    function toggleStart() {
      if (!isRunning) {
        isRunning = true;
        requestWakeLock();

        // Resume audio context on user interaction
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }

        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'block';
        document.getElementById('resetBtn').style.display = 'block';
        document.getElementById('prevBtn').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'block';
        loadExercise(currentIdx); // Load current instead of 0 to allow resuming or jumping before start
        timerVar = setInterval(tick, 1000);
      }
    }

    function togglePause() {
      isPaused = !isPaused;
      const btn = document.getElementById('pauseBtn');
      btn.innerText = isPaused ? "RESUME" : "PAUSE";
      btn.style.background = isPaused ? "#27ae60" : "#555";
    }

    function prevExercise() {
      if (currentIdx > 0) {
        jumpToExercise(currentIdx - 1);
      }
    }

    function nextExercise() {
      if (currentIdx < exercises.length - 1) {
        jumpToExercise(currentIdx + 1);
      } else {
        complete();
      }
    }

    function loadExercise(idx) {
      if (idx >= exercises.length) {
        complete();
        return;
      }
      currentIdx = idx;
      currentStep = 0; // Always start with SETUP
      updateIndicators(idx);

      const ex = exercises[idx];

      // Load video only once per exercise change
      const vId = ex.vid;
      const container = document.getElementById('video-container');

      if (navigator.onLine) {
        container.innerHTML = `<iframe src="https://www.youtube.com/embed/${vId}?autoplay=1&mute=1&loop=1&playlist=${vId}&rel=0&controls=1&playsinline=1" allow="autoplay; encrypted-media"></iframe>`;
      } else {
        container.innerHTML = `
          <div style="position: relative; width: 100%; height: 100%; background: #000;">
            <img src="https://i.ytimg.com/vi/${vId}/hqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.7;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 8px; font-weight: bold;">
              OFFLINE MODE
            </div>
          </div>
        `;
      }

      loadStep();
    }

    function loadStep() {
      const ex = exercises[currentIdx];

      // Step 0: SETUP
      if (currentStep === 0) {
        timeLeft = SETUP_TIME;
        document.getElementById('exercise-name').innerText = "GET READY";
        document.getElementById('exercise-desc').innerText = `Up Next: ${ex.name}`;
        return;
      }

      // Logic for Double Sided
      if (ex.doubleSide) {
        const totalWorkTime = ex.duration - SETUP_TIME - SWITCH_TIME;
        const halfTime = Math.floor(totalWorkTime / 2);

        if (currentStep === 1) { // LEFT
          timeLeft = halfTime;
          document.getElementById('exercise-name').innerText = `${ex.name} (LEFT)`;
          document.getElementById('exercise-desc').innerText = `${ex.desc} (Left Side)`;
        } else if (currentStep === 2) { // SWITCH
          timeLeft = SWITCH_TIME;
          document.getElementById('exercise-name').innerText = "SWITCH SIDE";
          document.getElementById('exercise-desc').innerText = "Quickly prepare to switch sides!";
        } else if (currentStep === 3) { // RIGHT
          timeLeft = totalWorkTime - halfTime; // Remainder
          document.getElementById('exercise-name').innerText = `${ex.name} (RIGHT)`;
          document.getElementById('exercise-desc').innerText = `${ex.desc} (Right Side)`;
        }
      } else {
        // Standard Exercise
        if (currentStep === 1) {
          timeLeft = ex.duration - SETUP_TIME;
          document.getElementById('exercise-name').innerText = ex.name;
          document.getElementById('exercise-desc').innerText = ex.desc;
        }
      }
    }

    function tick() {
      if (isPaused) return;

      // Beep logic for last 5 seconds of any phase
      if (timeLeft <= 5 && timeLeft > 0) {
        playBeep(timeLeft === 1 ? 1200 : 880);
      }

      if (timeLeft <= 0) {
        // Transition Logic
        const ex = exercises[currentIdx];

        if (ex.doubleSide) {
           // Flow: 0(Setup) -> 1(Left) -> 2(Switch) -> 3(Right) -> Next Exercise
           if (currentStep < 3) {
             currentStep++;
             loadStep();
           } else {
             loadExercise(currentIdx + 1);
           }
        } else {
           // Flow: 0(Setup) -> 1(Work) -> Next Exercise
           if (currentStep < 1) {
             currentStep++;
             loadStep();
           } else {
             loadExercise(currentIdx + 1);
           }
        }
      } else {
        timeLeft--;
        totalElapsed++;
        updateUI();
      }
    }

    function updateUI() {
      const m = Math.floor(timeLeft / 60);
      const s = timeLeft % 60;
      document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;

      const progress = (totalElapsed / 600) * 100;
      document.getElementById('progress-bar').style.width = progress + "%";
    }

    function resetWorkout() {
      clearInterval(timerVar);
      releaseWakeLock();
      isRunning = false;
      isPaused = false;
      totalElapsed = 0;
      currentIdx = 0; // Reset index
      currentStep = 0;
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('startBtn').innerText = "RESTART";
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'none';
      document.getElementById('prevBtn').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';
      document.getElementById('timer').innerText = "10:00";
      document.getElementById('exercise-name').innerText = "Session reset";
      document.getElementById('exercise-desc').innerText = "Press START to begin your 10-minute routine.";
      document.getElementById('video-container').innerHTML = '<div style="padding-top:20%; color:#666;">Reset completed</div>';
      document.getElementById('progress-bar').style.width = "0%";
      updateIndicators(-1); // Clear active indicator
    }

    function complete() {
      clearInterval(timerVar);
      releaseWakeLock();
      document.getElementById('exercise-name').innerText = "DONE! YOU ARE READY!";
      document.getElementById('exercise-desc').innerText = "Session completed. Have a great ride!";
      document.getElementById('timer').innerText = "00:00";
      document.getElementById('video-container').innerHTML = "<h2 style='color:#f39c12; padding-top:15%;'>GREAT WORK!</h2>";
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((reg) => console.log('Service Worker registered!', reg))
          .catch((err) => console.log('Service Worker registration failed', err));

        navigator.serviceWorker.addEventListener('controllerchange', () => {
          // Reload page when new SW takes control to show latest version
          window.location.reload();
        });
      });
    }
  </script>
</body>

</html>
